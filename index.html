<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×—× ×™×”</title>
    <link rel="stylesheet" href="./styles.css?v=1">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <style>
        /* Simple Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background-color: #2c3e50;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            font-size: 1.2rem;
            border-radius: 8px;
            border: 1px solid #7f8c8d;
            background: #34495e;
            color: white;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- Dashboard View (Default) -->
    <div id="dashboard-view" class="container">
        <header>
            <h1>×—× ×™×”</h1>
            <div class="header-controls">
                <span id="location-status" class="status-dot"></span>
            </div>
        </header>

        <main>
            <section id="lot-a">
                <h2>×—× ×™×•×Ÿ A - ×©××•×¨</h2>
                <div class="cards-container">
                    <!-- Cards injected by JS -->
                </div>
            </section>

            <section id="lot-b">
                <h2>×—× ×™×•×Ÿ B - ××–×“××Ÿ</h2>
                <div class="lot-b-controls">
                    <button id="ticket-btn" class="primary-btn">
                        <span>ğŸ…¿ï¸ ×—× ×™×ª×™ ×‘×—× ×™×•×Ÿ B</span>
                        <small>×§×— ×›×¨×˜×™×¡</small>
                    </button>
                    <div class="stats-card">
                        <h3>×¡×”"×› ×”×—×•×“×©</h3>
                        <div id="ticket-count" class="counter">0</div>
                    </div>
                </div>
            </section>
        </main>
        <footer>
            <button id="admin-trigger-btn" style="
            background-color: #f0f4f8; 
            border: 2px solid #00008B; 
            border-radius: 12px;
            cursor: pointer; 
            color: #00008B; 
            font-weight: bold; 
            font-size: 1.3rem; 
            padding: 15px 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            gap: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        ">
                <span style="font-size: 1.5rem;">ğŸ”</span>
                <span>×›× ×™×¡×ª ×× ×”×œ ××¢×¨×›×ª</span>
            </button>
        </footer>
    </div>

    <!-- Identity Modal -->
    <div id="identity-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">×”×–×“×”×•×ª</h2>
            <p>×× × ×”×›× ×¡ ××ª ××¡×¤×¨×š.</p>
            <form id="identity-form">
                <input type="number" id="identity-input" class="modal-input" min="1" max="999" required
                    placeholder="××¡×¤×¨ ××©×ª××©" autofocus>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel">×‘×™×˜×•×œ</button>
                    <button type="submit" id="modal-confirm">××™×©×•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin View -->
    <div id="admin-view" class="container hidden">
        <header>
            <h1>×¤×× ×œ × ×™×”×•×œ</h1>
            <button id="back-to-dash">×™×¦×™××”</button>
        </header>
        <main>
            <div class="admin-grid">
                <div class="card">
                    <h3>××©×ª××©×™×</h3>
                    <div id="users-list" class="list-container"></div>
                </div>
                <div class="card">
                    <div class="flex-header">
                        <h3>×™×•×× ×™× ×•×¡×˜×˜×™×¡×˜×™×§×”</h3>
                        <div class="export-actions">
                            <button onclick="exportToExcel()" class="icon-btn" title="×™×™×¦×•× ×œ××§×¡×œ">ğŸ“Š
                                Excel</button>
                            <button onclick="exportToWord()" class="icon-btn" title="×™×™×¦×•× ×œ×•×•×¨×“">ğŸ“
                                Word</button>
                            <button onclick="exportToPDF()" class="icon-btn" title="×”×“×¤×¡×” / PDF">ğŸ–¨ï¸
                                PDF</button>
                            <button id="refresh-reports">×¨×¢× ×Ÿ</button>
                        </div>
                    </div>

                    <div id="reports-container" class="list-container">
                        <!-- Tables will be injected here -->
                    </div>

                    <div class="danger-zone">
                        <h4>××™×¤×•×¡ ××¢×¨×›×ª ×—×•×“×©×™</h4>
                        <p class="warning-text">âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×¨×™×©×•××™×, ×ª××¤×¡ ××ª ×›×œ ×”×—× ×™×•×ª ×•×ª××¤×¡ ××ª
                            ×”××•× ×™×.
                            <strong>×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨!</strong>
                        </p>
                        <label>
                            <input type="checkbox" id="confirm-export-check">
                            ×©××¨×ª×™ ××ª ×“×•×—×•×ª ×”×—×•×“×© (×—×•×‘×” ×œ×¡××Ÿ)
                        </label>
                        <button id="global-reset-btn" class="danger-btn" disabled>ğŸ›‘ ×”×ª×—×œ ×—×•×“×© ×—×“×© (××™×¤×•×¡
                            ××œ×)</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function () {
            function startApp() {
                console.log("Starting App Logic...");

                // detect if running on GitHub Pages or local file
                const isGitHubPages = window.location.hostname.includes('github.io') || window.location.protocol === 'file:';
                const IS_DEMO_MODE = isGitHubPages || true;

                const API_URL = '/api';
                const PARKING_LAT = 31.9054;
                const PARKING_LON = 35.0055;
                const MAX_DISTANCE_METERS = 300;

                let spots = [];
                let monthlyTickets = 0;
                let isLocationValid = false;

                const dashboardView = document.getElementById('dashboard-view');
                const adminView = document.getElementById('admin-view');
                const locationStatus = document.getElementById('location-status');
                const cardsContainer = document.querySelector('.cards-container');
                const ticketBtn = document.getElementById('ticket-btn');
                const ticketCount = document.getElementById('ticket-count');

                const identityModal = document.getElementById('identity-modal');
                const identityForm = document.getElementById('identity-form');
                const identityInput = document.getElementById('identity-input');
                const modalCancel = document.getElementById('modal-cancel');
                const modalTitle = document.getElementById('modal-title');

                function checkLocation() {
                    if (!navigator.geolocation) {
                        if (locationStatus) locationStatus.style.backgroundColor = "#e74c3c";
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const dist = getDistanceFromLatLonInM(
                                position.coords.latitude,
                                position.coords.longitude,
                                PARKING_LAT,
                                PARKING_LON
                            );

                            if (dist <= MAX_DISTANCE_METERS) {
                                isLocationValid = true;
                                if (locationStatus) {
                                    locationStatus.style.backgroundColor = "#2ecc71";
                                    locationStatus.title = `Location verified (${Math.round(dist)}m)`;
                                }
                            } else {
                                isLocationValid = false;
                                if (locationStatus) {
                                    locationStatus.style.backgroundColor = "#e74c3c";
                                    locationStatus.title = `Too far (${Math.round(dist)}m)`;
                                }
                            }
                        },
                        (err) => {
                            console.error(err);
                            isLocationValid = false;
                            if (locationStatus) locationStatus.style.backgroundColor = "#e74c3c";
                        },
                        { enableHighAccuracy: true }
                    );
                }

                function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
                    var R = 6371;
                    var dLat = deg2rad(lat2 - lat1);
                    var dLon = deg2rad(lon2 - lon1);
                    var a =
                        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    var d = R * c;
                    return d * 1000;
                }

                function deg2rad(deg) { return deg * (Math.PI / 180); }

                function promptIdentity(title = "×”×–×“×”×•×ª") {
                    return new Promise((resolve) => {
                        if (!identityModal) { alert("Missing modal"); return resolve(null); }
                        modalTitle.textContent = title;
                        identityModal.classList.add('visible');
                        identityInput.value = '';
                        identityInput.focus();

                        const handleSubmit = (e) => {
                            e.preventDefault();
                            if (identityInput.value) {
                                cleanup();
                                resolve(identityInput.value);
                            }
                        };

                        const handleCancel = () => { cleanup(); resolve(null); };

                        const cleanup = () => {
                            identityForm.removeEventListener('submit', handleSubmit);
                            modalCancel.removeEventListener('click', handleCancel);
                            identityModal.classList.remove('visible');
                        };

                        identityForm.addEventListener('submit', handleSubmit);
                        modalCancel.addEventListener('click', handleCancel);
                    });
                }

                async function fetchState() {
                    initDemoData();
                    renderDashboard();
                }

                function initDemoData() {
                    const today = new Date().toDateString();
                    const lastResetDate = localStorage.getItem('last_reset_date');

                    if (lastResetDate !== today) {
                        // New day, reset everything
                        localStorage.removeItem('demo_spots_v3');
                        localStorage.setItem('last_reset_date', today);
                        console.log("Midnight Reset Executed");
                    }

                    try {
                        const stored = localStorage.getItem('demo_spots_v3');
                        if (stored) spots = JSON.parse(stored);
                    } catch (e) { console.error(e); }

                    if (!Array.isArray(spots) || spots.length === 0) {
                        spots = Array.from({ length: 5 }, (_, i) => ({
                            id: i + 1,
                            status: 'free',
                            occupantId: null,
                            timestamp: null
                        }));
                        saveDemoData();
                    }
                    monthlyTickets = parseInt(localStorage.getItem('demo_tickets_v3') || '0');

                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = "position:fixed;bottom:0;left:0;background:lime;color:black;padding:5px;z-index:9999;font-weight:bold;font-size:14px;width:100%;text-align:center;";
                    debugDiv.textContent = `SYSTEM ONLINE: v6-PREMIUM | SPOTS: ${spots.length}`;
                    document.body.appendChild(debugDiv);
                }

                function saveDemoData() {
                    localStorage.setItem('demo_spots_v3', JSON.stringify(spots));
                    localStorage.setItem('demo_tickets_v3', monthlyTickets);
                }

                async function toggleSpot(spotId, currentOccupantId) {
                    const userIdStr = await promptIdentity("×”×›× ×¡ ××¡×¤×¨ ××©×ª××©");
                    if (!userIdStr) return;
                    const userId = parseInt(userIdStr);

                    // 1. Location Logic (300m rule, exempt 90-99)
                    const isTestUser = (userId >= 90 && userId <= 99);
                    if (!isTestUser && !isLocationValid) {
                        alert("××ª×” ×¨×—×•×§ ××“×™ ××”×—× ×™×•×Ÿ (×—×•×‘×” ×œ×”×™×•×ª ×‘×˜×•×•×— 300 ××˜×¨).");
                        return;
                    }

                    const spot = spots.find(s => s.id === spotId);
                    if (spot) {
                        const isOccupied = spot.status === 'occupied';

                        if (isOccupied) {
                            // Release Attempt
                            // 2. Owner-Only Release Logic (Admin 99 can always release)
                            if (spot.occupantId !== userId && userId !== 99) {
                                alert("×©×’×™××”: ×¨×§ ××™ ×©×ª×¤×¡ ××ª ×”×—× ×™×” ×™×›×•×œ ×œ×©×—×¨×¨ ××•×ª×”.");
                                return;
                            }
                            spot.status = 'free';
                            spot.occupantId = null;
                        } else {
                            // Occupy Attempt
                            spot.status = 'occupied';
                            spot.occupantId = userId;
                        }
                        saveDemoData();
                        renderDashboard();
                    }
                }

                function renderDashboard() {
                    if (!cardsContainer) return;
                    cardsContainer.innerHTML = '';
                    spots.sort((a, b) => a.id - b.id).forEach(spot => {
                        const isOccupied = spot.status === 'occupied';
                        const card = document.createElement('div');
                        card.className = `parking-card ${isOccupied ? 'occupied' : 'free'}`;
                        const statusText = isOccupied ? `××©×ª××© ${spot.occupantId}` : '×¤× ×•×™';

                        let animalImg = '';
                        // Map IDs 1-5 to specific 3D animals
                        const animals = { 1: 'butterfly_3d', 2: 'rabbit_3d', 3: 'bear_3d', 4: 'fox_3d', 5: 'kingfisher_3d' };

                        if (animals[spot.id]) {
                            animalImg = `<img src="./animals/${animals[spot.id]}.png" class="animal-icon" alt="${animals[spot.id]}" onerror="this.style.display='none'">`;
                        }

                        card.innerHTML = `<div class="card-number">${spot.id}</div>${animalImg}<div class="card-status">${statusText}</div>`;
                        card.addEventListener('click', () => toggleSpot(spot.id, spot.occupantId));
                        cardsContainer.appendChild(card);
                    });
                    if (ticketCount) ticketCount.textContent = monthlyTickets;
                }

                if (ticketBtn) {
                    ticketBtn.addEventListener('click', async () => {
                        const userIdStr = await promptIdentity("×”×›× ×¡ ××¡×¤×¨ ×œ×›×¨×˜×™×¡");
                        if (!userIdStr) return;
                        monthlyTickets++;
                        saveDemoData();
                        renderDashboard();
                        alert("×›×¨×˜×™×¡ × ×œ×§×— (Demo)");
                    });
                }

                // Admin Logic
                const adminTrigger = document.getElementById('admin-trigger-btn');
                const backToDash = document.getElementById('back-to-dash');

                if (adminTrigger) {
                    adminTrigger.onclick = async () => {
                        const userIdStr = await promptIdentity("×›× ×™×¡×ª ×× ×”×œ (99)");
                        if (userIdStr === '99') {
                            if (dashboardView) dashboardView.classList.add('hidden');
                            if (adminView) adminView.classList.remove('hidden');
                            renderAdmin(); // <--- Call render function
                        } else if (userIdStr) {
                            alert("××™×Ÿ ×’×™×©×”");
                        }
                    };
                }

                function renderAdmin() {
                    const usersList = document.getElementById('users-list');
                    const reportsContainer = document.getElementById('reports-container');

                    if (usersList) {
                        const occupiedSpots = spots.filter(s => s.status === 'occupied');
                        if (occupiedSpots.length === 0) {
                            usersList.innerHTML = '<p>××™×Ÿ ×¨×›×‘×™× ×‘×—× ×™×” ×›×¨×’×¢.</p>';
                        } else {
                            let html = '<table style="width:100%; border-collapse: collapse; color: white;"><thead><tr style="border-bottom: 1px solid #7f8c8d;"><th>×—× ×™×”</th><th>××©×ª××©</th></tr></thead><tbody>';
                            occupiedSpots.forEach(s => {
                                html += `<tr><td style="padding: 10px;">${s.id}</td><td>${s.occupantId}</td></tr>`;
                            });
                            html += '</tbody></table>';
                            usersList.innerHTML = html;
                        }
                    }

                    if (reportsContainer) {
                        const occupiedCount = spots.filter(s => s.status === 'occupied').length;
                        const freeCount = spots.length - occupiedCount;
                        reportsContainer.innerHTML = `
                            <div style="display: flex; justify-content: space-around; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div><strong>×ª×¤×•×¡×”:</strong> ${occupiedCount}</div>
                                <div><strong>×¤× ×•×™:</strong> ${freeCount}</div>
                                <div><strong>×—× ×™×•×ª B ×”×—×•×“×©:</strong> ${monthlyTickets}</div>
                            </div>
                        `;
                    }
                }

                if (backToDash) {
                    backToDash.addEventListener('click', () => {
                        if (adminView) adminView.classList.add('hidden');
                        if (dashboardView) dashboardView.classList.remove('hidden');
                    });
                }

                // Admin Reset Logic
                const confirmCheck = document.getElementById('confirm-export-check');
                const globalResetBtn = document.getElementById('global-reset-btn');

                if (confirmCheck && globalResetBtn) {
                    confirmCheck.addEventListener('change', (e) => {
                        globalResetBtn.disabled = !e.target.checked;
                        globalResetBtn.style.opacity = e.target.checked ? "1" : "0.5";
                    });

                    globalResetBtn.addEventListener('click', async () => {
                        if (confirm("×”×× ××ª×” ×‘×˜×•×—? ×¤×¢×•×œ×” ×–×• ×ª××—×§ ×”×›×œ!")) {
                            localStorage.removeItem('demo_spots_v3');
                            localStorage.removeItem('demo_tickets_v3');
                            alert("×”××¢×¨×›×ª ××•×¤×¡×” ×‘×”×¦×œ×—×”!");
                            location.reload();
                        }
                    });
                }

                // Exports
                window.exportToExcel = function () { alert("Not available in Demo"); };
                window.exportToWord = function () { alert("Not available in Demo"); };
                window.exportToPDF = function () { window.print(); };

                checkLocation();
                initDemoData();
                renderDashboard();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startApp);
            } else {
                startApp();
            }
        })();
    </script>
</body>

</html>