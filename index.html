<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×—× ×™×”</title>
    <link rel="stylesheet" href="./styles.css?v=1">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <style>
        /* Simple Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background-color: #2c3e50;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            font-size: 1.2rem;
            border-radius: 8px;
            border: 1px solid #7f8c8d;
            background: #34495e;
            color: white;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>

<body>

    <!-- Dashboard View (Default) -->
    <div id="dashboard-view" class="container">
        <header>
            <h1>×—× ×™×”</h1>
            <div class="header-controls">
                <div class="header-controls">
                    <!-- Location status removed -->
                </div>
            </div>
        </header>

        <main>
            <section id="lot-a">
                <h2>×—× ×™×•×Ÿ A - ×©××•×¨</h2>
                <div class="cards-container">
                    <!-- Cards injected by JS -->
                </div>
            </section>

            <section id="lot-b">
                <h2>×—× ×™×•×Ÿ B - ××–×“××Ÿ</h2>
                <div class="lot-b-controls">
                    <button id="ticket-btn" class="primary-btn">
                        <span>ğŸ…¿ï¸ ×—× ×™×ª×™ ×‘×—× ×™×•×Ÿ B</span>
                        <small>×§×— ×›×¨×˜×™×¡</small>
                    </button>
                    <div class="stats-card">
                        <h3>×¡×”"×› ×”×—×•×“×©</h3>
                        <div id="ticket-count" class="counter">0</div>
                    </div>
                </div>
            </section>
        </main>
        <footer>
            <button id="admin-trigger-btn" style="
            background-color: #f0f4f8; 
            border: 2px solid #00008B; 
            border-radius: 12px;
            cursor: pointer; 
            color: #00008B; 
            font-weight: bold; 
            font-size: 1.3rem; 
            padding: 15px 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            gap: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        ">
                <span style="font-size: 1.5rem;">ğŸ”</span>
                <span>×›× ×™×¡×ª ×× ×”×œ ××¢×¨×›×ª</span>
            </button>
        </footer>
    </div>

    <!-- Identity Modal -->
    <div id="identity-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">×”×–×“×”×•×ª</h2>
            <p>×× × ×”×›× ×¡ ××ª ××¡×¤×¨×š.</p>
            <form id="identity-form">
                <input type="number" id="identity-input" class="modal-input" min="1" max="999" required
                    placeholder="××¡×¤×¨ ××©×ª××©" autofocus>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel">×‘×™×˜×•×œ</button>
                    <button type="submit" id="modal-confirm">××™×©×•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin View -->
    <div id="admin-view" class="container hidden">
        <header>
            <h1>×¤×× ×œ × ×™×”×•×œ</h1>
            <button id="back-to-dash">×™×¦×™××”</button>
        </header>
        <main>
            <div class="admin-grid">
                <div class="card">
                    <h3>××©×ª××©×™×</h3>
                    <div id="users-list" class="list-container"></div>
                </div>
                <div class="card">
                    <div class="flex-header">
                        <h3>×™×•×× ×™× ×•×¡×˜×˜×™×¡×˜×™×§×”</h3>
                        <div class="export-actions">
                            <button onclick="exportToExcel()" class="icon-btn" title="×™×™×¦×•× ×œ××§×¡×œ">ğŸ“Š
                                Excel</button>
                            <button onclick="exportToWord()" class="icon-btn" title="×™×™×¦×•× ×œ×•×•×¨×“">ğŸ“
                                Word</button>
                            <button onclick="exportToPDF()" class="icon-btn" title="×”×“×¤×¡×” / PDF">ğŸ–¨ï¸
                                PDF</button>
                            <button id="refresh-reports">×¨×¢× ×Ÿ</button>
                        </div>
                    </div>

                    <div id="reports-container" class="list-container">
                        <!-- Tables will be injected here -->
                    </div>

                    <div class="danger-zone">
                        <h4>××™×¤×•×¡ ××¢×¨×›×ª ×—×•×“×©×™</h4>
                        <p class="warning-text">âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×¨×™×©×•××™×, ×ª××¤×¡ ××ª ×›×œ ×”×—× ×™×•×ª ×•×ª××¤×¡ ××ª
                            ×”××•× ×™×.
                            <strong>×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨!</strong>
                        </p>
                        <label>
                            <input type="checkbox" id="confirm-export-check">
                            ×©××¨×ª×™ ××ª ×“×•×—×•×ª ×”×—×•×“×© (×—×•×‘×” ×œ×¡××Ÿ)
                        </label>
                        <button id="global-reset-btn" class="danger-btn" disabled>ğŸ›‘ ×”×ª×—×œ ×—×•×“×© ×—×“×© (××™×¤×•×¡
                            ××œ×)</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function () {
            function startApp() {
                console.log("Starting App Logic...");

                // detect if running on GitHub Pages or local file
                const isGitHubPages = window.location.hostname.includes('github.io') || window.location.protocol === 'file:';
                const IS_DEMO_MODE = isGitHubPages || true;

                const API_URL = '/api';
                // Geolocation constants removed

                let spots = [];
                let monthlyTickets = 0;
                // isLocationValid removed

                const dashboardView = document.getElementById('dashboard-view');
                const adminView = document.getElementById('admin-view');
                // locationStatus removed
                const cardsContainer = document.querySelector('.cards-container');
                const ticketBtn = document.getElementById('ticket-btn');
                const ticketCount = document.getElementById('ticket-count');

                const identityModal = document.getElementById('identity-modal');
                const identityForm = document.getElementById('identity-form');
                const identityInput = document.getElementById('identity-input');
                const modalCancel = document.getElementById('modal-cancel');
                const modalTitle = document.getElementById('modal-title');

                const firebaseConfig = {
                    apiKey: "AIzaSyBVRfrhByD7aGLFZjSX3m33LM-IQUJy_Tw",
                    authDomain: "parkmodi.firebaseapp.com",
                    databaseURL: "https://parkmodi-default-rtdb.firebaseio.com",
                    projectId: "parkmodi",
                    storageBucket: "parkmodi.firebasestorage.app",
                    messagingSenderId: "677614863921",
                    appId: "1:677614863921:web:41504426e6470f3e5ab710"
                };

                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.database();

                function promptIdentity(title = "×”×–×“×”×•×ª") {
                    return new Promise((resolve) => {
                        if (!identityModal) { alert("Missing modal"); return resolve(null); }
                        modalTitle.textContent = title;
                        identityModal.classList.add('visible');
                        identityInput.value = '';
                        identityInput.focus();

                        const handleSubmit = (e) => {
                            e.preventDefault();
                            if (identityInput.value) {
                                cleanup();
                                resolve(identityInput.value);
                            }
                        };

                        const handleCancel = () => { cleanup(); resolve(null); };

                        const cleanup = () => {
                            identityForm.removeEventListener('submit', handleSubmit);
                            modalCancel.removeEventListener('click', handleCancel);
                            identityModal.classList.remove('visible');
                        };

                        identityForm.addEventListener('submit', handleSubmit);
                        modalCancel.addEventListener('click', handleCancel);
                    });
                }

                function checkDailyReset() {
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                    db.ref('sys/lastResetDate').once('value', (snapshot) => {
                        const lastReset = snapshot.val();

                        if (lastReset !== today) {
                            console.log("New day detected. Resetting parking spots...");

                            // Transaction to ensure only one client triggers the reset
                            db.ref('sys/lastResetDate').transaction((currentDate) => {
                                if (currentDate !== today) {
                                    return today;
                                }
                                return; // Abort if already updated
                            }, (error, committed, snapshot) => {
                                if (error) {
                                    console.error("Reset transaction failed abnormaly", error);
                                } else if (committed) {
                                    // This client won the race to reset
                                    console.log("Performing daily reset...");

                                    const defaultSpots = Array.from({ length: 5 }, (_, i) => ({
                                        id: i + 1,
                                        status: 'free',
                                        occupantId: null,
                                        timestamp: null
                                    }));

                                    // Reset spots and tickets
                                    db.ref('spots').set(defaultSpots);
                                    db.ref('tickets').set(0);
                                    // alert("×™×•× ×—×“×©! ×”××¢×¨×›×ª ××•×¤×¡×” ×‘××•×¤×Ÿ ××•×˜×•××˜×™."); // Optional alert
                                } else {
                                    console.log("Daily reset already performed by another client.");
                                }
                            });
                        }
                    });
                }

                function fetchState() {
                    checkDailyReset(); // Check for reset on load/state fetch

                    // Normalize data structure if needed
                    db.ref('spots').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (!data) {
                            // Initialize default spots if DB is empty
                            const defaultSpots = Array.from({ length: 5 }, (_, i) => ({
                                id: i + 1,
                                status: 'free',
                                occupantId: null,
                                timestamp: null
                            }));
                            db.ref('spots').set(defaultSpots);
                            spots = defaultSpots;
                        } else {
                            spots = data;
                        }
                        renderDashboard();
                        renderAdmin(); // Update admin view if open
                    });

                    db.ref('tickets').on('value', (snapshot) => {
                        monthlyTickets = snapshot.val() || 0;
                        if (ticketCount) ticketCount.textContent = monthlyTickets;
                        renderAdmin();
                    });
                }

                async function toggleSpot(spotId, currentOccupantId) {
                    const userIdStr = await promptIdentity("×”×›× ×¡ ××¡×¤×¨ ××©×ª××©");
                    if (!userIdStr) return;
                    const userId = parseInt(userIdStr);

                    // 1. Location Logic Removed

                    // Find the current state of the spot directly from the local cache (which is synced)
                    // But for atomicity, transactions are better, though simple updates allow less conflict.
                    // We will use a transaction to ensure we don't overwrite changes.

                    const spotRef = db.ref(`spots/${spotId - 1}`); // Assuming spotId 1 maps to index 0

                    spotRef.transaction((currentSpot) => {
                        if (currentSpot) {
                            if (currentSpot.status === 'occupied') {
                                // Release Attempt
                                // 2. Owner-Only Release Logic (Admin 99 can always release)
                                if (currentSpot.occupantId !== userId && userId !== 99) {
                                    // We can't alert inside a transaction easily, so we handle it after or abort.
                                    // Returning undefined aborts the transaction.
                                    return;
                                }
                                return { ...currentSpot, status: 'free', occupantId: null };
                            } else {
                                // Occupy Attempt
                                return { ...currentSpot, status: 'occupied', occupantId: userId };
                            }
                        }
                        return currentSpot;
                    }, (error, committed, snapshot) => {
                        if (error) {
                            alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª: " + error);
                        } else if (!committed) {
                            // Logic failure (e.g. permission denied by code above)
                            // We need to check WHY it wasn't committed. 
                            // In this simple transaction, if it returns undefined, it's not committed.

                            // Re-check locally to give specific error
                            const spot = spots.find(s => s.id === spotId);
                            if (spot && spot.status === 'occupied' && spot.occupantId !== userId && userId !== 99) {
                                alert("×©×’×™××”: ×¨×§ ××™ ×©×ª×¤×¡ ××ª ×”×—× ×™×” ×™×›×•×œ ×œ×©×—×¨×¨ ××•×ª×”.");
                            } else {
                                console.log("Transaction aborted or not needed.");
                            }
                        }
                    });
                }

                function renderDashboard() {
                    if (!cardsContainer) return;
                    cardsContainer.innerHTML = '';
                    spots.sort((a, b) => a.id - b.id).forEach(spot => {
                        const isOccupied = spot.status === 'occupied';
                        const card = document.createElement('div');
                        card.className = `parking-card ${isOccupied ? 'occupied' : 'free'}`;
                        const statusText = isOccupied ? `××©×ª××© ${spot.occupantId}` : '×¤× ×•×™';

                        let animalImg = '';
                        // Map IDs 1-5 to specific 3D animals
                        const animals = { 1: 'butterfly_3d', 2: 'rabbit_3d', 3: 'bear_3d', 4: 'fox_3d', 5: 'kingfisher_3d' };

                        if (animals[spot.id]) {
                            animalImg = `<img src="./animals/${animals[spot.id]}.png" class="animal-icon" alt="${animals[spot.id]}" onerror="this.style.display='none'">`;
                        }

                        card.innerHTML = `<div class="card-number">${spot.id}</div>${animalImg}<div class="card-status">${statusText}</div>`;
                        card.addEventListener('click', () => toggleSpot(spot.id, spot.occupantId));
                        cardsContainer.appendChild(card);
                    });
                    if (ticketCount) ticketCount.textContent = monthlyTickets;
                }

                if (ticketBtn) {
                    ticketBtn.addEventListener('click', async () => {
                        const userIdStr = await promptIdentity("×”×›× ×¡ ××¡×¤×¨ ×œ×›×¨×˜×™×¡");
                        if (!userIdStr) return;

                        db.ref('tickets').transaction((currentCount) => {
                            return (currentCount || 0) + 1;
                        });
                        alert("×›×¨×˜×™×¡ × ×¨×©× ×‘×”×¦×œ×—×”");
                    });
                }

                // Admin Logic
                const adminTrigger = document.getElementById('admin-trigger-btn');
                const backToDash = document.getElementById('back-to-dash');

                if (adminTrigger) {
                    adminTrigger.onclick = async () => {
                        const userIdStr = await promptIdentity("×›× ×™×¡×ª ×× ×”×œ (99)");
                        if (userIdStr === '99') {
                            if (dashboardView) dashboardView.classList.add('hidden');
                            if (adminView) adminView.classList.remove('hidden');
                            renderAdmin(); // <--- Call render function
                        } else if (userIdStr) {
                            alert("××™×Ÿ ×’×™×©×”");
                        }
                    };
                }

                function renderAdmin() {
                    const usersList = document.getElementById('users-list');
                    const reportsContainer = document.getElementById('reports-container');

                    if (usersList) {
                        const occupiedSpots = spots.filter(s => s.status === 'occupied');
                        if (occupiedSpots.length === 0) {
                            usersList.innerHTML = '<p>××™×Ÿ ×¨×›×‘×™× ×‘×—× ×™×” ×›×¨×’×¢.</p>';
                        } else {
                            let html = '<table style="width:100%; border-collapse: collapse; color: white;"><thead><tr style="border-bottom: 1px solid #7f8c8d;"><th>×—× ×™×”</th><th>××©×ª××©</th></tr></thead><tbody>';
                            occupiedSpots.forEach(s => {
                                html += `<tr><td style="padding: 10px;">${s.id}</td><td>${s.occupantId}</td></tr>`;
                            });
                            html += '</tbody></table>';
                            usersList.innerHTML = html;
                        }
                    }

                    if (reportsContainer) {
                        const occupiedCount = spots.filter(s => s.status === 'occupied').length;
                        const freeCount = spots.length - occupiedCount;
                        reportsContainer.innerHTML = `
                            <div style="display: flex; justify-content: space-around; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div><strong>×ª×¤×•×¡×”:</strong> ${occupiedCount}</div>
                                <div><strong>×¤× ×•×™:</strong> ${freeCount}</div>
                                <div><strong>×—× ×™×•×ª B ×”×—×•×“×©:</strong> ${monthlyTickets}</div>
                            </div>
                        `;
                    }
                }

                if (backToDash) {
                    backToDash.addEventListener('click', () => {
                        if (adminView) adminView.classList.add('hidden');
                        if (dashboardView) dashboardView.classList.remove('hidden');
                    });
                }

                // Admin Reset Logic
                const confirmCheck = document.getElementById('confirm-export-check');
                const globalResetBtn = document.getElementById('global-reset-btn');

                if (confirmCheck && globalResetBtn) {
                    confirmCheck.addEventListener('change', (e) => {
                        globalResetBtn.disabled = !e.target.checked;
                        globalResetBtn.style.opacity = e.target.checked ? "1" : "0.5";
                    });

                    globalResetBtn.addEventListener('click', async () => {
                        if (confirm("×”×× ××ª×” ×‘×˜×•×—? ×¤×¢×•×œ×” ×–×• ×ª××—×§ ×”×›×œ!")) {
                            // Firebase Reset
                            const defaultSpots = Array.from({ length: 5 }, (_, i) => ({
                                id: i + 1,
                                status: 'free',
                                occupantId: null,
                                timestamp: null
                            }));

                            await db.ref('spots').set(defaultSpots);
                            await db.ref('tickets').set(0);

                            alert("×”××¢×¨×›×ª ××•×¤×¡×” ×‘×”×¦×œ×—×”!");
                            // No need to reload, listeners will update UI
                        }
                    });
                }

                // Exports
                window.exportToExcel = function () { alert("Not available in Demo"); };
                window.exportToWord = function () { alert("Not available in Demo"); };
                window.exportToPDF = function () { window.print(); };

                // checkLocation(); // Removed
                fetchState(); // Replaces initDemoData + renderDashboard
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startApp);
            } else {
                startApp();
            }
        })();
    </script>
</body>

</html>